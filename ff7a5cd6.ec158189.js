(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{115:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return o})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return p}));var r=n(3),i=n(7),a=(n(0),n(120)),l={id:"windows-firewall",title:"Opening the Windows Firewall",sidebar_label:"Windows Firewall",slug:"tutorials/windows-firewall"},o={unversionedId:"windows-firewall",id:"windows-firewall",isDocsHomePage:!1,title:"Opening the Windows Firewall",description:"If you're running Windows, then in order for your server to be accessible from outside of your local machine you'll need to open the Windows Firewall for your application. You can do this either from the Windows Defender UI or using code in your application. In both case, you will need elevated privledges (admin account) to make changes to the firewall.",source:"@site/docs\\tut-windowsfirewall.md",slug:"/tutorials/windows-firewall",permalink:"/grapevine/docs/tutorials/windows-firewall",editUrl:"https://github.com/scottoffen/grapevine-docs/edit/master/docs/tut-windowsfirewall.md",version:"current",sidebar_label:"Windows Firewall",sidebar:"someSidebar",previous:{title:"Running Without Admin Access",permalink:"/grapevine/docs/tutorials/run-without-admin-account"},next:{title:"Style Guide",permalink:"/grapevine/docs/style-guide"}},c=[{value:"Open Windows Firewall Via UI",id:"open-windows-firewall-via-ui",children:[]},{value:"Open Windows Firewall Via Code",id:"open-windows-firewall-via-code",children:[{value:"Add The COM References",id:"add-the-com-references",children:[]},{value:"Create a FirewallPolicy Class",id:"create-a-firewallpolicy-class",children:[]},{value:"Add Middleware Extension Method",id:"add-middleware-extension-method",children:[]},{value:"Using Your Middleware Extension",id:"using-your-middleware-extension",children:[]}]}],s={toc:c};function p(e){var t=e.components,l=Object(i.a)(e,["components"]);return Object(a.b)("wrapper",Object(r.a)({},s,l,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"If you're running Windows, then in order for your server to be accessible from outside of your local machine you'll need to open the Windows Firewall for your application. You can do this either from the Windows Defender UI or using code in your application. In both case, you will need elevated privledges (admin account) to make changes to the firewall."),Object(a.b)("h2",{id:"open-windows-firewall-via-ui"},"Open Windows Firewall Via UI"),Object(a.b)("p",null,"These instructions are for Windows 10. For earlier versions of Windows, consult the documentation for specific steps."),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Open the ",Object(a.b)("em",{parentName:"p"},"Windows Defender Firewall")," Control Panel module by running ",Object(a.b)("inlineCode",{parentName:"p"},"control firewall.cpl")," from the command line.")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"On the left hand navigation, click on ",Object(a.b)("strong",{parentName:"p"},"Allow an app or feature through Windows Defender Firewall")," to open the ",Object(a.b)("em",{parentName:"p"},"Allowed Apps")," dialog."))),Object(a.b)("p",null,Object(a.b)("img",{alt:"img",src:n(170).default})),Object(a.b)("ol",{start:3},Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Click on the ",Object(a.b)("strong",{parentName:"p"},"Change settings")," button to allow the settings to be changed. If you are not logged in to an admin account, you will be prompted for admin credentials.")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Click on ",Object(a.b)("strong",{parentName:"p"},"Allow another app...")," button to open the ",Object(a.b)("em",{parentName:"p"},"Add an app")," dialog. Click the ",Object(a.b)("strong",{parentName:"p"},"Browse")," button to browse to your applications executable file, and select it."))),Object(a.b)("p",null,Object(a.b)("img",{alt:"img",src:n(171).default})),Object(a.b)("ol",{start:5},Object(a.b)("li",{parentName:"ol"},"Click on the ",Object(a.b)("strong",{parentName:"li"},"Add")," button to add allow the application access through the firewall.")),Object(a.b)("h2",{id:"open-windows-firewall-via-code"},"Open Windows Firewall Via Code"),Object(a.b)("p",null,"This requires accessing some COM references, which AFAIK can't be done in a class library. But you can easily add it to your application using the example below."),Object(a.b)("h3",{id:"add-the-com-references"},"Add The COM References"),Object(a.b)("p",null,"You will first want to add two COM references to your application, ",Object(a.b)("inlineCode",{parentName:"p"},"hnetcfg.dll")," and ",Object(a.b)("inlineCode",{parentName:"p"},"FirewallAPI.dll"),". Both DLLs are located in ",Object(a.b)("inlineCode",{parentName:"p"},"C:\\Windows\\System32")," directory."),Object(a.b)("ol",null,Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"In Visual Studio, right click on your project dependencies and select ",Object(a.b)("strong",{parentName:"p"},"Add COM Reference"),".")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Click the ",Object(a.b)("strong",{parentName:"p"},"Browse")," button in the lower right hand corner of the dialog box.")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Navigate to ",Object(a.b)("inlineCode",{parentName:"p"},"C:\\Windows\\System32")," and select ",Object(a.b)("inlineCode",{parentName:"p"},"hnetcfg.dll"),", then clicke the ",Object(a.b)("strong",{parentName:"p"},"Add")," button.")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Repeat steps 2 and 3 for ",Object(a.b)("inlineCode",{parentName:"p"},"FirewallAPI.dll"),".")),Object(a.b)("li",{parentName:"ol"},Object(a.b)("p",{parentName:"li"},"Click ",Object(a.b)("strong",{parentName:"p"},"OK")," in the dialog box to return to Visual Studio."))),Object(a.b)("p",null,Object(a.b)("img",{alt:"img",src:n(172).default})),Object(a.b)("p",null,"The COM references should now be added to your project."),Object(a.b)("p",null,Object(a.b)("img",{alt:"img",src:n(173).default})),Object(a.b)("h3",{id:"create-a-firewallpolicy-class"},"Create a FirewallPolicy Class"),Object(a.b)("p",null,"Next we'll create a simple class that will create our firewall rule and policy. We'll include methods with matching delegate signatures for our server starting and stopping event handlers to add and remove the rule from the policy."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp",metastring:'title="FirewallPolicy.cs"',title:'"FirewallPolicy.cs"'}),'using System;\nusing Grapevine;\nusing NetFwTypeLib;\n\nnamespace Samples\n{\n    public class FirewallPolicy\n    {\n        private INetFwRule _rule;\n        private INetFwPolicy2 _policy;\n\n        public string AppExecutablePath { get; set; }\n\n        public string Description { get; set; }\n\n        public string Name { get; set; }\n\n        public INetFwPolicy2 Policy => _policy;\n\n        public INetFwRule Rule => _rule;\n\n        private INetFwRule GenerateRule()\n        {\n            if (_policy == null)\n                _policy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID("HNetCfg.FwPolicy2"));\n\n            _rule = (INetFwRule)Activator.CreateInstance(Type.GetTypeFromProgID("HNetCfg.FWRule"));\n            _rule.ApplicationName = AppExecutablePath;\n            _rule.Action = NET_FW_ACTION_.NET_FW_ACTION_ALLOW;\n            _rule.Description = Description;\n            _rule.Enabled = true;\n            _rule.InterfaceTypes = "All";\n            _rule.Name = Name;\n\n            return _rule;\n        }\n\n        public void AddFirewallPolicy(IRestServer server)\n        {\n            if (_rule != null) return;\n            _policy.Rules.Add(GenerateRule());\n        }\n\n        public void RemoveFirewallPolicy(IRestServer server)\n        {\n            if (_rule == null) return;\n            _policy.Rules.Remove(_rule.Name);\n            _rule = null;\n        }\n    }\n}\n')),Object(a.b)("h3",{id:"add-middleware-extension-method"},"Add Middleware Extension Method"),Object(a.b)("p",null,"You can add a middleware extension to handle adding and removing your policy."),Object(a.b)("p",null,"In the example here, I use the ",Object(a.b)("inlineCode",{parentName:"p"},"IRestServer.AfterStarting")," handler to add the policy because I don't want the firewall to be open to receiving messages until the server has finished starting up."),Object(a.b)("p",null,"Likewise, I use the ",Object(a.b)("inlineCode",{parentName:"p"},"IRestServer.BeforeStopping")," handler to remove the policy because I want to ensure no more requests are coming in before I begin shutting down the server."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp",metastring:'title="FirewallPolicyExtensions.cs"',title:'"FirewallPolicyExtensions.cs"'}),"using Grapevine;\n\nnamespace Samples\n{\n    public static class FirewallPolicyExtensions\n    {\n        public static IRestServer UseFirewallPolicy(this IRestServer server, FirewallPolicy policy)\n        {\n            server.AfterStarting += policy.AddFirewallPolicy;\n            server.BeforeStopping += policy.RemoveFirewallPolicy;\n            return server;\n        }\n    }\n}\n")),Object(a.b)("h3",{id:"using-your-middleware-extension"},"Using Your Middleware Extension"),Object(a.b)("p",null,"You can now add your firewall policy to the server - make sure to do this before starting the server."),Object(a.b)("pre",null,Object(a.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'var firewallPolicy = new FirewallPolicy\n{\n    AppExecutablePath = "", //Application Executable Path\n    Description = "Description of your firewall rule",\n    Name = "" // Your Application Name\n};\n\nserver.UseFirewallPolicy(firewallPolicy);\n')))}p.isMDXComponent=!0},120:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return w}));var r=n(0),i=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=i.a.createContext({}),p=function(e){var t=i.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return i.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},b=i.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),d=p(n),b=r,w=d["".concat(l,".").concat(b)]||d[b]||u[b]||a;return n?i.a.createElement(w,o(o({ref:t},s),{},{components:n})):i.a.createElement(w,o({ref:t},s))}));function w(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=b;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var s=2;s<a;s++)l[s]=n[s];return i.a.createElement.apply(null,l)}return i.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"},170:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/windows-defender-allowed-apps-aef9710368286123873d1a3ba357ebeb.png"},171:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/windows-defender-add-allowed-apps-22e8f5fbd449170224dd7f270f7672f7.png"},172:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/add-com-references-93f0678b943a877a26395431afca5c7c.png"},173:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/show-com-references-973388ad58b2f9f83ede2afd4ddf15f4.png"}}]);
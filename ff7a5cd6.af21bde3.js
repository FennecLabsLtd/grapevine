(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{114:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return a})),t.d(n,"metadata",(function(){return o})),t.d(n,"toc",(function(){return c})),t.d(n,"default",(function(){return u}));var r=t(3),i=t(7),l=(t(0),t(119)),a={id:"windows-firewall",title:"Opening the Windows Firewall",sidebar_label:"Windows Firewall",slug:"tutorials/windows-firewall"},o={unversionedId:"windows-firewall",id:"windows-firewall",isDocsHomePage:!1,title:"Opening the Windows Firewall",description:"If you're running Windows, then in order for your server to be accessible from outside of your local machine you'll need to open the Windows Firewall for your application. This requires accessing some COM references, which AFAIK can't be done in a class library. But you can easily add it to your application using the example below.",source:"@site/docs\\tut-windowsfirewall.md",slug:"/tutorials/windows-firewall",permalink:"/grapevine/docs/tutorials/windows-firewall",editUrl:"https://github.com/scottoffen/grapevine-docs/edit/master/docs/tut-windowsfirewall.md",version:"current",sidebar_label:"Windows Firewall",sidebar:"someSidebar",previous:{title:"Implementing Windows Authentication",permalink:"/grapevine/docs/tutorials/windows-authentication"}},c=[{value:"Add The COM References",id:"add-the-com-references",children:[]},{value:"Create a FirewallPolicy Class",id:"create-a-firewallpolicy-class",children:[]},{value:"Add Middleware Extension Method",id:"add-middleware-extension-method",children:[]},{value:"Using Your Middleware Extension",id:"using-your-middleware-extension",children:[]}],s={toc:c};function u(e){var n=e.components,a=Object(i.a)(e,["components"]);return Object(l.b)("wrapper",Object(r.a)({},s,a,{components:n,mdxType:"MDXLayout"}),Object(l.b)("p",null,"If you're running Windows, then in order for your server to be accessible from outside of your local machine you'll need to open the Windows Firewall for your application. This requires accessing some COM references, which AFAIK can't be done in a class library. But you can easily add it to your application using the example below."),Object(l.b)("h2",{id:"add-the-com-references"},"Add The COM References"),Object(l.b)("p",null,"You will first want to add two COM references to your application, ",Object(l.b)("inlineCode",{parentName:"p"},"hnetcfg.dll")," and ",Object(l.b)("inlineCode",{parentName:"p"},"FirewallAPI.dll"),". Both DLLs are located in ",Object(l.b)("inlineCode",{parentName:"p"},"C:\\Windows\\System32")," directory."),Object(l.b)("ol",null,Object(l.b)("li",{parentName:"ol"},"In Visual Studio, right click on your project dependencies and select ",Object(l.b)("strong",{parentName:"li"},"Add COM Reference"),"."),Object(l.b)("li",{parentName:"ol"},"Click the ",Object(l.b)("strong",{parentName:"li"},"Browse")," button in the lower right hand corner of the dialog box."),Object(l.b)("li",{parentName:"ol"},"Navigate to ",Object(l.b)("inlineCode",{parentName:"li"},"C:\\Windows\\System32")," and select ",Object(l.b)("inlineCode",{parentName:"li"},"hnetcfg.dll"),", then clicke the ",Object(l.b)("strong",{parentName:"li"},"Add")," button."),Object(l.b)("li",{parentName:"ol"},"Repeat steps 2 and 3 for ",Object(l.b)("inlineCode",{parentName:"li"},"FirewallAPI.dll"),"."),Object(l.b)("li",{parentName:"ol"},"Click ",Object(l.b)("strong",{parentName:"li"},"OK")," in the dialog box to return to Visual Studio.")),Object(l.b)("p",null,Object(l.b)("img",{alt:"img",src:t(169).default})),Object(l.b)("p",null,"The COM references should now be added to your project."),Object(l.b)("p",null,Object(l.b)("img",{alt:"img",src:t(170).default})),Object(l.b)("h2",{id:"create-a-firewallpolicy-class"},"Create a FirewallPolicy Class"),Object(l.b)("p",null,"Next we'll create a simple class that will create our firewall rule and policy. We'll include methods with matching delegate signatures for our server starting and stopping event handlers to add and remove the rule from the policy."),Object(l.b)("pre",null,Object(l.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp",metastring:'title="FirewallPolicy.cs"',title:'"FirewallPolicy.cs"'}),'using System;\nusing Grapevine;\nusing NetFwTypeLib;\n\nnamespace Samples\n{\n    public class FirewallPolicy\n    {\n        private INetFwRule _rule;\n        private INetFwPolicy2 _policy;\n\n        public string AppExecutablePath { get; set; }\n\n        public string Description { get; set; }\n\n        public string Name { get; set; }\n\n        public INetFwPolicy2 Policy => _policy;\n\n        public INetFwRule Rule => _rule;\n\n        private INetFwRule GenerateRule()\n        {\n            if (_policy == null)\n                _policy = (INetFwPolicy2)Activator.CreateInstance(Type.GetTypeFromProgID("HNetCfg.FwPolicy2"));\n\n            _rule = (INetFwRule)Activator.CreateInstance(Type.GetTypeFromProgID("HNetCfg.FWRule"));\n            _rule.ApplicationName = AppExecutablePath;\n            _rule.Action = NET_FW_ACTION_.NET_FW_ACTION_ALLOW;\n            _rule.Description = Description;\n            _rule.Enabled = true;\n            _rule.InterfaceTypes = "All";\n            _rule.Name = Name;\n\n            return _rule;\n        }\n\n        public void AddFirewallPolicy(IRestServer server)\n        {\n            if (_rule != null) return;\n            _policy.Rules.Add(GenerateRule());\n        }\n\n        public void RemoveFirewallPolicy(IRestServer server)\n        {\n            if (_rule == null) return;\n            _policy.Rules.Remove(_rule.Name);\n            _rule = null;\n        }\n    }\n}\n')),Object(l.b)("h2",{id:"add-middleware-extension-method"},"Add Middleware Extension Method"),Object(l.b)("p",null,"You can add a middleware extension to handle adding and removing your policy."),Object(l.b)("p",null,"In the example here, I use the ",Object(l.b)("inlineCode",{parentName:"p"},"IRestServer.AfterStarting")," handler to add the policy because I don't want the firewall to be open to receiving messages until the server has finished starting up."),Object(l.b)("p",null,"Likewise, I use the ",Object(l.b)("inlineCode",{parentName:"p"},"IRestServer.BeforeStopping")," handler to remove the policy because I want to ensure no more requests are coming in before I begin shutting down the server."),Object(l.b)("pre",null,Object(l.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp",metastring:'title="FirewallPolicyExtensions.cs"',title:'"FirewallPolicyExtensions.cs"'}),"using Grapevine;\n\nnamespace Samples\n{\n    public static class FirewallPolicyExtensions\n    {\n        public static IRestServer UseFirewallPolicy(this IRestServer server, FirewallPolicy policy)\n        {\n            server.AfterStarting += policy.AddFirewallPolicy;\n            server.BeforeStopping += policy.RemoveFirewallPolicy;\n            return server;\n        }\n    }\n}\n")),Object(l.b)("h2",{id:"using-your-middleware-extension"},"Using Your Middleware Extension"),Object(l.b)("p",null,"You can now add your firewall policy to the server - make sure to do this before starting the server."),Object(l.b)("pre",null,Object(l.b)("code",Object(r.a)({parentName:"pre"},{className:"language-csharp"}),'var firewallPolicy = new FirewallPolicy\n{\n    AppExecutablePath = "", //Application Executable Path\n    Description = "Description of your firewall rule",\n    Name = "" // Your Application Name\n};\n\nserver.UseFirewallPolicy(firewallPolicy);\n')))}u.isMDXComponent=!0},119:function(e,n,t){"use strict";t.d(n,"a",(function(){return d})),t.d(n,"b",(function(){return w}));var r=t(0),i=t.n(r);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},l=Object.keys(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=i.a.createContext({}),u=function(e){var n=i.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=u(e.components);return i.a.createElement(s.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return i.a.createElement(i.a.Fragment,{},n)}},b=i.a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,a=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),d=u(t),b=r,w=d["".concat(a,".").concat(b)]||d[b]||p[b]||l;return t?i.a.createElement(w,o(o({ref:n},s),{},{components:t})):i.a.createElement(w,o({ref:n},s))}));function w(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,a=new Array(l);a[0]=b;var o={};for(var c in n)hasOwnProperty.call(n,c)&&(o[c]=n[c]);o.originalType=e,o.mdxType="string"==typeof e?e:r,a[1]=o;for(var s=2;s<l;s++)a[s]=t[s];return i.a.createElement.apply(null,a)}return i.a.createElement.apply(null,t)}b.displayName="MDXCreateElement"},169:function(e,n,t){"use strict";t.r(n),n.default=t.p+"assets/images/add-com-references-93f0678b943a877a26395431afca5c7c.png"},170:function(e,n,t){"use strict";t.r(n),n.default=t.p+"assets/images/show-com-references-973388ad58b2f9f83ede2afd4ddf15f4.png"}}]);